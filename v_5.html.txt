<!--#inlude virtual=/inc/vbutil.inc-->

<style>
    #wrap {}

    #map {
        width: 100%;
        height: 250px;
        display: none;
    }

    li {
        cursor: pointer;
        list-style: none;
    }

    #add_input {
        width: 90%;
        border: 0;
        border: none;
        outline: none;
        background: none;
        cursor: text;
        /* 상단위치 화면에 따라 변경 必 */
        margin-top: -45px;
        margin-left: 20px;
        font-size: 1.5em !important;
        /* !important; 정확히 왜 안되는지 모르겠네*/
    }

    #add_input::placeholder {
        font-size: 1.5em;
        color: #c2c2c2;
        padding-right: 40px;
    }

    .search_btn {
        display: inline-block;
        width: 30px;
        height: 30px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3C!--! Font Awesome Pro 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --%3E%3Cpath d='M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z'/%3E%3C/svg%3E");
        background-size: cover;
        margin-top: -45px;
    }

    #zipcode {
        display: inline-block;
    }

    #address-form {
        display: inline-block;
    }

    .add_li {
        display: block;
        text-align: left;
        font-size: 1.5em;
        padding: 5px 5px 5px 30px;
        vertical-align: middle;
        margin-right: 10px;
    }

    .add_li:first-child {
        margin-top: -9px;
    }
</style>
</head>

<body>

    <% cName=request("cName") '영문국가명
    cCode=request("cCode")	' 국가코드 lCode=request("lCode") '언어코드
    if cCode="HK" then initialZipCode="070"
    
    ' response.write "lCode: " &lCode&"<br>"
        ' response.write "cCode: "&cCode&"<br>"
        ' response.write "cName: "&cName&"<br>"



        ' %>
        <div id="wrap">

            <br />
            <div id="s_container"></div>
            <input id="add_input" type="text" class="presubmit" submit="mySubmit">
            <a href="javascript:void(0);" class="search_btn submitonenter"></a>
            <hr>
            <input type="hidden" id="hidden_country" />
            <input type="hidden" id="lCode" value=<%=lCode%>/>
            <input type="hidden" id="cName" value=<%=cName%>/>
            <input type="hidden" id="cCode" value=<%=cCode%>/>
            <!--이거 밖으로 같이 보내야 돼!value-->
            <input value="<%=initialZipCode%>" type="hidden" id="zipcode" placeholder="우편번호" />
            <ul id="results"></ul>
            <div id="map"></div>
        </div>
        <script type="text/javascript">
          
            //포커스 
            $(document).ready(function () {
                $("#add_input").focus();
                var loadMapsAPI = true;
                
                if (loadMapsAPI) {
                    var script = document.createElement('script');
                    script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyAlp3ZFcVhVXXorS_kpaaQ3vXk4hm-_Qa0&libraries=places&callback=initMap";
                    script.async = true;
                    script.defer = true;
                    document.head.appendChild(script);
                }
            });

            //왜 get_lang js 못써요?! 우씨 화가나! 
             var cName = "<%=cName%>";
             console.log(cName,"cName 확인 1");
                

            $("#add_input").keypress(function (event) {
                if (event.which == 13) {
                    event.preventDefault();
                    mySubmit(event);
                }  
            }).attr('placeholder', "언어별 샘플 주소넣기");

            //*************************************************
            //map, infowindow, address 전역
            //*************************************************

            var map;
            var infowindow;
            var placesService;
            var address;
            // var postal_code = "";
            var addInput = $("#add_input");
            var flag = false;

            //****맵 초기화 
            function initMap() {
                var defalut = new google.maps.LatLng(0, 0);
                infowindow = new google.maps.InfoWindow();
                map = new google.maps.Map(document.getElementById("map"), {
                    center: defalut,
                    zoom: 15,
                });
                placesService = new google.maps.places.PlacesService(map)
            }

            var search_btn = $(".search_btn");
            search_btn.on("click", function (e) {
                mySubmit(e)
            });

            //*****서치이벤트
            function mySubmit(e) {
                e.preventDefault()
                var lCode = $("#lCode").val();
                var zipcodeInput = $("#zipcode");
                address = `${addInput.val()} ${$("#hidden_country").val()}`;
                const autocompl = new google.maps.places.AutocompleteService();

                //*****자동주소 호출
                autocompl.getPlacePredictions(
                    { input: address, language: lCode },
                    function (predictions, status) {
                        console.log(predictions, "1");
                        if (status != google.maps.places.PlacesServiceStatus.OK) {
                            console.error("Error_code 확인: " + status);
                            //*****상세주소 X, 사용자 직접 수정
                            if (status == google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                                alert("주소를 찾을 수 없습니다. 상세주소 정확히 직접 적어주세요.");
                                $("#div_zipwrap").slideToggle();
                                $("#recv_addr2").val(addInput.val());
                                $("#recv_zip").focus()
                            }
                            else alert(status);
                            return;
                        }

                        //*****주소 리스트 생성
                        $("#results").html("");
                        predictions.forEach(function (predi) {
                            var li = $('<li class="add_li"></li>');
                            placesService.getDetails(
                                { placeId: predi.place_id, language: "en" },
                                function (place, status) {
                                    var postal_code = "";
                                    for (let i = 0; i < place.address_components.length; i++) {
                                        if (place.address_components[i].types.includes("postal_code")) {
                                            postal_code = place.address_components[i].long_name;
                                            break;
                                        }
                                    }
                                    //*****우편번호 없거나 정식주소 없을때
                                    if (!postal_code || !place.formatted_address) {
                                        li.text("우편번호 정보 없음 - " + predi.description);
                                        $("#results").append(li);
                                        if (!flag) {
                                            alert("우편번호를 찾을 수 없습니다. 상세한 주소한 주소와 우편번호를 입력해주세요.");
                                            flag = true;
                                        }
                                    } else {
                                        li.text(postal_code + ' ' + predi.description);
                                        $("#results").append(li);
                                    }
                                    //******리스트 클릭
                                    li.on("click", function () {
                                        var en_address = place.formatted_address;
                                        addInput.val(place.formatted_address).focus();
                                        if (!postal_code || !place.formatted_address) {
                                            $("#div_zipwrap").slideToggle();
                                            $("#recv_addr2").val(addInput.val());
                                            $("#recv_zip").focus();
                                        } else {
                                            $("#recv_zip").val(postal_code);
                                            $("#recv_addr2").val(en_address);
                                            $("#div_zipwrap").slideToggle();
                                        }
                                    });
                                });
                        });
                    })
            }
            window.initMap = initMap;
        </script>

</body>

</html>